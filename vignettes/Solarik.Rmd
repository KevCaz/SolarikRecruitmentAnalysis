---
title: "How to reproduce the analysis"
author: Kevin Cazelles and Kevin Solarik
date: '`r Sys.Date()`'
output:
  #rmarkdown::html_vignette
  html_document:
      theme: readable
      toc: true
      toc_float: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Vignette Title}
  \usepackage[utf8]{inputenc}
---


```{r, include = FALSE}
library(seedlingsRecruitment)
```

<br>

This vignette aims at guiding the reader through the different steps of the
analysis carried out in *Priority effects will prevent range shifts of temperate tree species into the boreal forest.*[^not1].

# Data

Data are currently archived on [Dryad](https://datadryad.org/stash) at the following URL <https://doi.org/10.5061/dryad.q573n5tdx>.

<br>

## Sites of the study

As explained in the original study, recruitment data have been measured on three different sites:

- 'abi': Abitibi
- 'bic': Le Bic
- 'sut': Sutton

The map below shows the location of those sites. For each site, extra information are available on click.

```{r map, message=FALSE, echo=FALSE, fig.width=9}
datS <- data.frame(
  id = c('abi', 'bic', 'sut'),
  name = c('Abitibi-Temiscaminque', 'Le Bic', 'Sutton'),
  lon = c(-79.401219, -68.817719, -72.541297),
  lat = c(48.162539, 48.333619, 45.112803),
  plots= c(400, 1024, 2000)
)
##
rownames(datS) <- datS$id
spSite <- sp::SpatialPointsDataFrame(
  datS[,c('lon', 'lat')],
  data = datS,
  proj4string = sp::CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0")
 )
 mapview::mapview(spSite)@map
```


<br>

## Tree species of the study

| abbr1 | abbr2 | Scientific Names      | TSN    |abi   |bic   |sut   |
|:------|:------|:----------------------|:-------|:-----|:-----|:-----|
| BF    | ABBA  | Abies balsamea        | 18032  |TRUE  |TRUE  |TRUE  |
| RM    | ACRU  | Acer rubrum           | 28728  |TRUE  |TRUE  |FALSE |
| SM    | ACSA  | Acer saccharum        | 28731  |TRUE  |TRUE  |TRUE  |
| YB    | BEAL  | Betula alleghaniensis | 19481  |FALSE |FALSE |TRUE  |
| WB    | BEPA  | Betula papyrifera     | 19489  |TRUE  |TRUE  |TRUE  |
| AB    | FAGR  | Fagus grandifolia     | 19462  |FALSE |FALSE |TRUE  |
| AS    | POTR  | Populus tremuloides   | 195773 |TRUE  |TRUE  |TRUE  |

: Abbreviations, names, TSN (Taxonomic Serial Number, visit the [Integrated
  Taxonomic Information System website](https://www.itis.gov/pdf/faq_itis_tsn.pdf)
  for more details about TSN) of the tree species considered and their
  respective presence in the three sites.


<br>

## Recruitment data

A link to the dataset would be added once data are released.
<!-- even as rda... -->






# Statistical models

Below are detailed the steps to reproduce our analysis.

## Models

### General equation

For a given species and a given year, the seeds recruitment depends on:

1. the fecundity of surrounding individuals of the same species;
2. the substrate favorability;
3. the neighborhood effect.


$$R_i = \text{STR}\sum_{j=1}^Sc_{i,j}f_{i,j}\sum_{k=1}^T\left(\frac{\text{DBH}_k}{30}\right)^2 \frac{1}{K}e^{-\text{DM}_{i,k}}e^{-\frac{h_i}{1-h_i}\sum_{l=1}^Ba_{i,l}}$$



### Number of parameters per process

| Ecological process  |abbr  |number of parameters|
|:--------------------|:-----|:-------------------|
| dispersion          |disp  |2                   |
| neighborhood effect |neigh |5                   |
| favorability        |favo  |1                   |



### Kernels

| numb | disp | which            | clip  |
|:-----|:-----|:-----------------|:------|
|0     |--    |non-significant   | -     |
|1     |dc    |lognormal         |clip   |
|2     |d-    |lognormal         |no-clip|
|3     |Dc    |power-exponential |clip   |
|4     |D-    |power-exponential |no-clip|



## Simulations

### Overall strategy

For each model, we estimate the parameters through the maximization of the
likelihood (minimization of the likelihood log-transformed) for the
corresponding data. As our model is not linear and highly customized we
optimized the likelihood with the simulated annealing algorithm implemented in
GenSA.

```{r}
citation("GenSA")
```


Here are the 15 first models (each row is a model) out of the
`r nrow(simuDesign)/7` tested for *Abies balsamea*.


```{r simudesign}
data(simuDesign)
knitr::kable(head(simuDesign, 15))
```



### Numerical implementation

For each row of `simuDesign`, columns are arguments passed to
`recruitmentAnalysis()` in which:

1. parameters are computed for the simulated annealing (`getParameters()`);

2. simulated annealing is performed (`GenSA()` from [GenSA](https://cran.r-project.org/web/packages/GenSA/index.html) package) to minimize the likelihood (`getLikelihood()`).


```{r getParameter}
knitr::kable(getParameters(TRUE, TRUE, TRUE, lognormal = FALSE))
```


### Example

The line below (not run) allows to run for the 16<sup>th</sup> model.

```{r, eval = FALSE}
res <- launchIt(iter = 16, simu = simuDesign, mxt = 100,
  record = "inst/res/test.txt", quiet = TRUE, path = "inst/dataReady/")
# value (likelihood)
res$value
# parameters value
res$par
```

Note that `test.txt` records all the values tested during the simulated algorithm and the corresponding likelihood based on which we obtain a confident interval.

```{r, eval = FALSE}
getConfInt("inst/res/test.txt", simuDesign, 16, basename_out = "inst/resf_")
```

### Figure 5

Once all models run and the best models identified, we draw figure 5 that is the dispersal kernels infered for one year seedlings


```{r}
figKernels(res_bestModels)
```

Similarly, we used this function to draw the same figure for 2 years seedlings (see Supplememtary Information of the paper):

```{r}
figKernels(res_bestModels, age = 2)
```


## References


[^not1]: Solarik et al. DOI: 2Badded
