---
title: Seedlings recruitment analysis of Solarik et al. XXXX paper.
author: Kevin Cazelles and Kevin Solarik
date: '`r Sys.Date()`'
output:
  # rmarkdown::html_vignette
  html_document:
      theme: readable
      toc: true
      toc_float: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Vignette Title}
  \usepackage[utf8]{inputenc}
---


```{r, echo=FALSE, message = FALSE}
devtools::load_all()
```

<br>

This vignette aims at guiding the reader through the different steps of the
analysis carried out in Solarik _et al._ XXXX. Data, R code and this vignette
are available at <https://github.com/KevCaz/seedlingsRecruitmentAnalysis>.

# Data

<br>

## Sites of the study

Recruitment data have been measured on three different sites:

- 'abi': Abitibi
- 'bic': Le Bic
- 'sut': Sutton

The map below show the location of those sites. For each sites some extra information are available on clicks.

```{r map, message=FALSE, echo=FALSE, fig.width=9}
datS <- data.frame(
  id = c('abi', 'bic', 'sut'),
  name = c('Abitibi-Temiscaminque', 'Le Bic', 'Sutton'),
  lon = c(-79.401219, -68.817719, -72.541297),
  lat = c(48.162539, 48.333619, 45.112803),
  plots= c(400, 1024, 2000)
)
##
rownames(datS) <- datS$id
spSite <- sp::SpatialPointsDataFrame(
  datS[,c('lon', 'lat')],
  data = datS,
  proj4string = sp::CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0")
 )
 mapview::mapview(spSite)@map
```


<br>

## Tree species of the study

| abbr1 | abbr2 | Scientific Names      | TSN    |abi  |bic  |sut  |
|:------|:------|:----------------------|:-------|:----|:----|:----|
| BF    | ABBA  | Abies balsamea        | 18032  |TRUE |TRUE |TRUE |
| RM    | ACRU  | Acer rubrum           | 28728  |TRUE |TRUE |TRUE |
| SM    | ACSA  | Acer saccharum        | 28731  |TRUE |TRUE |TRUE |
| YB    | BEAL  | Betula alleghaniensis | 19481  |TRUE |TRUE |TRUE |
| WB    | BEPA  | Betula papyrifera     | 19489  |TRUE |TRUE |TRUE |
| AB    | FAGR  | Fagus grandifolia     | 19462  |TRUE |TRUE |TRUE |
| AS    | POTR  | Populus tremuloides   | 195773 |TRUE |TRUE |TRUE |

: Abbreviations, names, TSN (Taxonomic Serial Number, viti the [Integrated
  Taxonomic Information System website](https://www.itis.gov/pdf/faq_itis_tsn.pdf)
  for more details about TSN) of the tree species considered and their
  respective presence in the three sites of the study.


<br>

## Recruitment data

A link to the dataset would hopefully be available before publication.
<!-- even as rda... -->







# Statistical models

Below are detailed the steps to reproduce our analysis.

## Models

### General equation

For a givens species and a given year, the seeds recruitment depends on:

- the fecondity of surrounding individuals of the same species
- the substrate favorability
- the neighborhood effect


$$R_i = \text{STR}\sum_{j=1}^Sc_{i,j}f_{i,j}\sum_{k=1}^T\left(\frac{\text{DBH}_k}{30}\right)^2 \frac{1}{K}e^{-\text{DM}_{i,k}}e^{-\frac{h_i}{1-h_i}\sum_{l=1}^Ba_{i,l}}$$


### Parameters

| Ecological process  |abbr  |number of parameters|
|:--------------------|:-----|:-------------------|
| dispersion          |disp  |2                   |
| neighborhood effect |neigh |5                   |
| favorability        |favo  |1                   |


### Kernels

| numb | disp | which          | clip  |
|:-----|:-----|:---------------|:------|
|0     |--    |non-significant | -     |
|1     |dc    |lognormal       |clip   |
|2     |d-    |lognormal       |no-clip|
|3     |Dc    |power-exponetial|clip   |
|4     |D-    |power-exponetial|no-clip|



## Simulations


### Overall strategy

Below we present the 15 first models (each row is a model) out of the
`r nrow(simuDesign)/7` we tested for  *Abies balsamea*.

```{r simudesign}
data(simuDesign)
knitr::kable(head(simuDesign, 15))
```

For each model, we estimate the parameters through the maximization of the
likelihood (minimization of the likelihood log-transformed) for the corresponding
data. As our model is not linear and highly customized we optimized the likelihood
with a simulated annealing algorithm.


<br>

### Numerical implementation

(implemented by the [GenSA](https://cran.r-project.org/web/packages/GenSA/index.html) package).
For different models (40 models for each combination site x species x year x age).


For each row of `simuDesign` column are arguments passed to `recruitmentAnalysis()`
in which:

1- parameters are computed for the simulated annealing (`getParameters()`)

2- simulated annealing is performed (`GenSA()` from GenSA package) to minimize
the likelihood (`getLikelihood()`).



```{r getParameter}
knitr::kable(getParameters(T, T, T, lognormal = FALSE))
```



## Example

Do it for the quick one (the one with nothing)
